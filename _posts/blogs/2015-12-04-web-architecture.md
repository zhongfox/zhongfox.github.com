---
layout: post
categories: [blog, sundry]
tags : [architecture]
title: 大型网站技术架构读书笔记
tags : [encoding, share]
---
{% include JB/setup %}


## 大型网站架构演化

1. 初始阶段

    单机+开源软件

    继续发展的瓶颈: 单机不能满足需求

2. 应用服务器, 数据服务器, 文件服务器分离

    各种服务器的资源需要不同

    继续发展的瓶颈: 数据库压力太大导致访问延迟

3. 使用缓存

    网站访问特点也有二八定律: 80%的业务访问集中在20%的热点数据

    缓存分本地缓存和远程分部式缓存

    继续发展的瓶颈: 访问高峰时应用服务器成为瓶颈

4. 应用服务器集群

    通过负载均衡调度服务器+应用服务器集群, 改善了并发处理能力, 实现了可伸缩性

    继续发展的瓶颈: 又是数据库负载

5. 数据库读写分离

    数据库主从分离, 热备, 实现读写分离, 从而改善数据库负载压力

    应用服务器配置专门的数据访问模块, 实现透明的读写分离

    继续发展的瓶颈: 网络访问需要加速

6. 使用CDN服务器和反向代理服务器

    CDN和反向代理原理都是缓存, 可以加快用户访问, 页减轻后端负载

    继续发展的瓶颈: 数据库系统和文件系统

7. 分布式文件系统和分布式数据库系统

    分布式数据库是网站数据库拆分的最后手段, 数据库按照业务分库, 部署到不同物理机器

    继续发展的瓶颈: 存储和检索越来越复杂

8. 使用NoSQL和搜索引擎

    NoSQL和搜索引擎对可伸缩的分布式具有很好的支持

    继续发展的瓶颈: 业务复杂

9. 业务拆分

    按照业务拆分不同应用, 每个应用独立部署维护, 应用之间通过超链接建立关系, 也可以通过消息队列进行数据分发

    继续发展的瓶颈: 业务越来越小, 存储系统越来越大, 部署维护越来越困难

10. 分布式服务

    提取个个业务应用中相同的业务操作, 作为服务独立部署, 提供分布式调用

11. 云平台

    云计算云存储

    大型网站解决了海量数据管理和高并发事务处理, 可以应用到其他网站

---

## 大型网站架构模式

**模式**描述了在我们周围不断重复发生的问题以及该问题解决方案的核心. 这样, 你就能一次又一次地使使用该方案而不必做重复的工作

### 分层

横向切分系统, 各层职责单一, 通过上层对下层依赖进行调用

目的:

* 各层的资源需求不一致
* 清晰的软件逻辑结构, 便于维护

实例:

* 网络7层协议
* 计算机硬件, 操作系统, 应用软件
* deal service

挑战和约束:

* 合理规划层次边界和接口
* 严格遵循分层约束, 禁止跨层调用或逆向调用


### 分割

纵向对软件进行切分, 按照功能和服务分割为高内聚低耦合的模块单元

分层和分割都可以提高网站的并发处理能力和扩展能力

分层分割的主要目的是便于分布式部署

### 分布式

作用:

* 提高性能: 分布式意味着可以使用更多的计算机资源, 提高并发能力
* 提高可扩展性

分布式带来的问题:

* 服务调用必须走网络
* 分离粒度越小, 服务器越多, 服务宕机的概率也就越大
* 分布式环境中数据一致性和事务难度增大

分布式需要量力而行, 切莫为了分布式而分布式

分布式方案:

* 分布式应用和服务 [考虑分布式, css编译没有考虑]
* 分布式静态资源 [js css 多个域名, 独立静态资源域名]
* 分布式数据和存储 [Nosql]
* 分布式计算
* 分布式配置
* 分布式锁
* 分布式文件系统

### 集群

作用:

* 提高可用性(高可用集群)
* 提高性能, 并发能力 (负载均衡集群)

题外: 分布式与集群的区别

一种观点(我倾向于):

* 分布式：一个业务分拆多个子业务，部署在不同的服务器上; 分布式强调的是任务差异性
* 集群：同一个业务，部署在多个服务器上; 集群强调的是任务的同一性

分布式是将不同的业务分布在不同的地方. 而集群是将多台服务器集中在一起, 实现同一个业务

分布式的每一个节点, 都可以做集群

另一种观点: 集群是个物理形态，分布式是个工作方式

集群: 只要是一堆机器，就可以叫集群，他们是不是一起协作不重要
分布式: 一个程序或系统，只要运行在不同的机器上，就可以叫分布式

**集群分类**

* 高可用集群
* 负载均衡集群
* 科学计算集群

### 缓存

* CDN
* 反向代理
* 本地缓存
* 分布式缓存

使用缓存的两个前提:

* 数据访问热点不均
* 数据存在一定时效性, 不会很快过期. 缓存时效性很短的数据会出现脏读 [秒杀数据为什么不能缓存]

### 异步

作用:

* 系统解耦, 异步架构是典型的生产者消费者模式, 两者不直接调用, 只要保持数据结构不变, 彼此功能实现可以随意变化而互不影响
* 提高可用性 (签到积分实例)
* 加快网站响应速度: 生产者在写入消息队列后马上返回, 无需等待消费者处理
* 消除并发访问高峰

影响: 影响用户体验, 业务流程. 需要产品设计

### 冗余

主要目的是容灾和可用性

实现方式:

* 集群也是一种冗余的实现
* 冷备份: 数据库定期备份
* 热备份: 数据库主从同步
* 灾备中心

### 自动化

* 自动化代码管理
* 自动化部署
* 自动化安全检测
* 自动化监控
* 自动化报警
* 自动化失效转移
* 自动化失效恢复
* 自动化降级
* 自动化分配资源

### 安全

---

## 大型网站核心架构要素

架构是**最高层次的规划, 是难以改变的决定**

架构五要素:

* 性能
* 可用性
* 伸缩性
* 扩展性
* 安全性

---

## 瞬时响应: 网站的高性能架构

## 性能指标

* 响应时间

* 并发数: 同事处理请求的数目

* 吞吐量: 体现系统的整体处理能力. 常见度量单位: 请求树/秒 页面数/秒 访问人数/天 TPS(每秒事务数) HPS(每秒HTTP请求数) QPS(每秒查询数)

  提高并发, 吞吐量增加
  继续提高, 吞吐量达到极限

* 性能计数器

  * System load(系统负载): 被CPU执行和等待的进程数目的总和, 反映系统忙闲程度的重要指标
  * 对象与线程数
  * 内存使用
  * CPU使用
  * 磁盘,网络IO等

---

## 性能测试方法

* 性能测试: 验证系统在资源可接受范围内, 是否达到性能预期
* 负载测试: 使系统某些性能指标达到安全临界值, 继续施压, 系统处理能力不增反降
* 压力测试: 超过安全负载, 继续施压使系统崩溃, 以获得系统最大承压能力
* 稳定性测试: 特定的软硬件网络环境下, 使用不均匀压力运行较长一段时间, 测试系统是否稳定

<img src="/assets/images/jiagou/xingnengceshi.png" />
<img src="/assets/images/jiagou/xingnengceshi2.png" />
