---
layout: post
categories: [blog, javascript]
tags : [nodejs pm2]
title: pm2
---
{% include JB/setup %}

---

### 安装

* npm install pm2@latest -g

### 使用

* `pm2 start app.js --name my-api -i max -- -a 23 ` 

   执行文件必须是js扩展名-i参数才有效(why?)

   `--`后的参数用于传递给执行脚本

  `-x` 使用fork模式, 默认是cluster模式

  `-e err.log -o out.log`

  `--node-args="--debug=7001 --trace-deprecation" ` node 参数(?)

* `pm2 list` [list|ls|l|status]

* `pm2 monit`

* `pm2 delete id/all/app_name`  online的也会被干掉

  删除指定的name的进程, 如果是一个name多进程, 一起删除

* `pm2 desc id/app_name` 注意id是pm中的id序号, 而不是pid

* `pm2 stop id/all/app_name` stop 停止进程, 但是进程还在

  停止指定的name的进程, 如果是一个name多进程, 一起停止

* `pm2 restart id/all/app_name` kills and restart,会重新加载代码, 但因为需要kill, 所以服务会中断

* `pm2 logs [id/app_name]` 不带参数应该是all

* `pm2 reloadLogs` 通过信号SIGUSR2让已经打开的日志窗口重启

* `pm2 reload all/app_name` 会算在restart次数中, 类似于平滑重启, Will 0s downtime reload 不过测试来看经常不成功

* `pm2 gracefulReload all/app_name`

### 集群

项目设计一定要符合**stateless**

* Sessions must not be stored in memory but shared via a database (Redis, Mongo, whatever)
* WebSocket/Socket.io should communicate via a database

---

### 参考

* <https://github.com/Unitech/pm2>
